name: Build and Test Lite

on: [push, pull_request]

jobs:
  build-linux:
    env:
      dependencies: |
        automake libtool gcc bc libjemalloc1 libjemalloc-dev    \
        libssl-dev llvm-dev libelf-dev libnuma-dev libpcap-dev  \
        python3-openssl python3-pip python3-sphinx              \
        selinux-policy-dev
      deb_dependencies: |
        linux-headers-$(uname -r) build-essential fakeroot devscripts equivs
      CC:          ${{ matrix.compiler }}
      DEB_PACKAGE: ${{ matrix.deb_package }}
      TESTSUITE:   ${{ matrix.testsuite }}

    name: linux ${{ join(matrix.*, ' ') }}
    runs-on: ubuntu-18.04
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        include:
          - compiler:     gcc
            testsuite:    test
            deb_package:  deb

    steps:
    - name: checkout
      uses: actions/checkout@v2

    - name: install common dependencies
      if:   matrix.deb_package == ''
      run:  sudo apt install -y ${{ env.dependencies }}
    - name: install dependencies for debian packages
      if:   matrix.deb_package != ''
      run:  sudo apt install -y ${{ env.deb_dependencies }}
    - name: install libunbound libunwind
      if:   matrix.m32 == ''
      run:  sudo apt install -y libunbound-dev libunwind-dev

    - name: prepare
      run:  ./.ci/linux-prepare.sh

    - name: build
      run:  PATH="$PATH:$HOME/bin" ./.ci/linux-build.sh

    - name: upload deb packages
      if:   matrix.deb_package != ''
      uses: actions/upload-artifact@v2
      with:
        name: deb-packages
        path: '/home/runner/work/ovs-private/*.deb'

    - name: copy logs on failure
      if: failure() || cancelled()
      run: |
        # upload-artifact@v2 throws exceptions if it tries to upload socket
        # files and we could have some socket files in testsuite.dir.
        # Also, upload-artifact@v2 doesn't work well enough with wildcards.
        # So, we're just archiving everything here to avoid any issues.
        mkdir logs
        cp config.log ./logs/
        cp -r ./*/_build/sub/tests/testsuite.* ./logs/ || true
        tar -czvf logs.tgz logs/
    - name: upload logs on failure
      if: failure() || cancelled()
      uses: actions/upload-artifact@v2
      with:
        name: logs-linux-${{ join(matrix.*, '-') }}
        path: logs.tgz